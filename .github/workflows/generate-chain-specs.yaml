name: Generate Local Chain Specs

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-chain-specs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y git protobuf-compiler

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.90.0
          target: wasm32v1-none
          components: rust-src
          override: true

      - name: Add rust-src
        run: rustup component add rust-src --toolchain 1.81.0-x86_64-unknown-linux-gnu

      - name: Rust cache
        uses: Swatinem/rust-cache@v2.8.1
        with:
          shared-key: "paseo-global-cache"
          cache-on-failure: true

      - name: Install pop
        run: |
          cargo install --git https://github.com/r0gue-io/pop-cli.git --branch main --locked

      - name: Generate chain specs
        run: |
          mkdir -p chain-specs/local

          chmod +x .scripts/generate_chain_specs.sh

          .scripts/generate_chain_specs.sh
        
      - name: Upload chain specs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: chain-specs
          path: chain-specs/
          retention-days: 1

  commit-changes:
    needs: generate-chain-specs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download chain specs artifacts
        uses: actions/download-artifact@v4
        with:
          name: chain-specs
          path: chain-specs/
      
      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.PASEO_CI_PAT }}

      - name: Commit changes
        run: |
          # Add all chain spec files using glob pattern
          git add chain-specs/local/*.json
          
          # Check if there are any changes to commit
          if git diff --staged --quiet; then
            echo "No changes detected in chain specs. Skipping commit."
          else
            # List the files that will be committed
            echo "Changes detected in the following files:"
            git diff --staged --name-status
            
            COMMIT_MESSAGE="Update chain specs for version ${{ inputs.tag_version }}"
            git commit -m "$COMMIT_MESSAGE"
            git push
            echo "Changes committed and pushed successfully."
          fi
